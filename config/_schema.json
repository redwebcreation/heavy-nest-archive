{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Nest config",
  "properties": {
    "$schema": {
      "type": "string",
      "description": "The Nest config schema"
    },
    "default_network": {
      "type": "string",
      "description": "The default docker network to use when creating a container",
      "default": "bridge"
    },
    "applications": {
      "type": "object",
      "description": "A list of applications that nest will deploy",
      "patternProperties": {
        "^[a-z][a-z.\\-0-9]+[a-z0-9]\\.[a-z0-9\\-]{2,}$": {
          "type": "object",
          "properties": {
            "image": {
              "pattern": "^[a-z]+(:[a-zA-Z0-9.\\-_]+)?$",
              "description": "The docker image to use for the application"
            },
            "env": {
              "type": "object",
              "description": "Environment variables to set for the application",
              "patternProperties": {
                "^[a-zA-Z0-9_]+$": {
                  "type": "string",
                  "description": "The value of the environment variable"
                }
              },
              "additionalProperties": false
            },
            "env_files": {
              "type": "array",
              "description": "Environment files to add in the container environment",
              "items": {
                "pattern": "^(.+)/([^/]+)$",
                "description": "The path to an environment file to load"
              }
            },
            "volumes": {
              "type": "array",
              "description": "Volumes to mount in the container",
              "items": {
                "pattern": "^.+:.+$",
                "description": "A volume to mount in the container"
              }
            },
            "warm": {
              "type": "boolean",
              "description": "Warm the application before starting it",
              "default": false
            },
            "log_policy": {
              "pattern": "^[a-zA-Z0-9_]+$",
              "description": "An existing log policy to use for the application"
            },
            "registry": {
              "type": "string",
              "description": "The registry to use to pull the image"
            },
            "network": {
              "type": "string",
              "description": "The docker network to use for the container",
              "default": "bridge"
            },
            "port": {
              "pattern": "^[0-9]+$",
              "description": "The port that the container exposes"
            }
          },
          "required": [
            "image"
          ],
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "production": {
      "type": "object",
      "properties": {
        "log_policy": {
          "pattern": "^[a-zA-Z0-9_]+$",
          "description": "The log policy to use for the production environment"
        },
        "http_port": {
          "pattern": "^[0-9]+$",
          "default": "80",
          "description": "The port that the proxy will listen on when using http"
        },
        "https_port": {
          "pattern": "^[0-9]+$",
          "default": "443",
          "description": "The port that the proxy will listen on when using https"
        }
      }
    },
    "log_policies": {
      "type": "array",
      "description": "A list of log policies that your applications may use",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "pattern": "^[a-zA-Z0-9_]+$",
            "description": "The name of the log policy"
          },
          "rules": {
            "type": "array",
            "description": "The rules to apply to the log policy",
            "items": {
              "type": "object",
              "properties": {
                "when": {
                  "pattern": "^(level|debug|info|warning|error|fatal|\\s|\\|<=|>=|<|>|==|!=)+$",
                  "description": "The conditions that the log level must match to get logged."
                },
                "level": {
                  "description": "The minimum level that the log must be to get logged",
                  "enum": [
                    "debug",
                    "info",
                    "warning",
                    "error",
                    "fatal"
                  ]
                }
              },
              "oneOf": [
                {
                  "required": [
                    "when"
                  ]
                },
                {
                  "required": [
                    "level"
                  ]
                }
              ],
              "additionalProperties": false
            }
          }
        }
      }
    },
    "registries": {
      "type": "array",
      "items": {
        "type": "object",
        "description": "A registry to use for pulling images",
        "properties": {
          "name": {
            "type": "string",
            "description": "The name of the registry"
          },
          "host": {
            "type": "string",
            "description": "The host of the registry"
          },
          "username": {
            "type": "string",
            "description": "The username to use when authenticating with the registry"
          },
          "password": {
            "type": "string",
            "description": "The password to use when authenticating with the registry"
          }
        },
        "required": [
          "name",
          "host",
          "username",
          "password"
        ],
        "additionalProperties": false
      }
    }
  },
  "required": [
    "applications"
  ],
  "additionalProperties": false
}
