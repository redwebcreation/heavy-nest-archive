#!/bin/bash
if [ -z "$1" ]; then
  echo "Usage: release [version]"
  exit 1
fi

# Git repo is dirty
if [[ $(git diff --stat) != '' ]]; then
  echo "Repo is dirty"
  exit 1
fi

echo "List of commits not synced with remote"
git cherry -v
echo "List ends here."

read -r

echo "Releasing version: $1"

GOOS=linux go build -ldflags="-w -s -X github.com/wormable/nest/globals.Version=$1" -gcflags=all="-l"

git log --pretty="* %H - %s" "$(git describe --tags --abbrev=0)"..HEAD --no-merges >releases-notes.txt

sed -i "/wip/d" releases-notes.txt
sed -i "/cleanup/d" releases-notes.txt

gh release create "$1" ./nest --title "Release $1" --notes-file releases-notes.txt

rm releases-notes.txt
